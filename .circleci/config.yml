version: 2

defaults: &defaults
  working_directory: ~/repo
jobs:
  test:
    docker:
    - image: circleci/node:8.9.1
    <<: *defaults  
    steps:
      - checkout

      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "package.json" }}
          - v1-dependencies-

      - run: npm install  #install node.js package
      - run:
          name: run build
          command: npm build
      - run:
          name: Run tests
          command: npm test
          
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package.json" }}

      - persist_to_workspace:
          root: ~/repo
          paths: .

  deploy:
    orbs:
      heroku: circleci/heroku@1.0.0
   executors:
  default:
    description:
      Uses the basic buildpack-deps image, which has the
      prerequisites for installing heroku's CLI.
    parameters:
      tag:
        type: string
        default: "bionic"
    docker:
      - image: buildpack-deps:<< parameters.tag >>

commands:
  install:
    steps:
      - run:
          name: "Install Heroku CLI, if necessary"
          command: |
            if [[ $(command -v heroku) == "" ]]; then
              curl https://cli-assets.heroku.com/install.sh | sh
            else
              echo "Heroku is already installed. No operation was performed."
            fi

  deploy-via-git:
    parameters:
      app-name:
        description:
          "The name of your Heroku App.
          For backwards compatibility the literal value
          `$HEROKU_APP_NAME` is the default, so you can
          easily use this command by setting an environment
          variable called HEROKU_APP_NAME"
        type: string
        default: $heruku-staging
      maintenance-mode:
        description:
          "Use this to automatically enable mantainance mode before pre-deploy steps
           and have it disabled after post-deploy steps have been run."
        type: boolean
        default: false
      api-key:
        description:
          "The API key to use. defaulting to the literal value $HEROKU_API_KEY, so you can
          populate the environment variable HEROKU_API_KEY and not need to declare a value in code."
        type: string
        default: $32eef67a-bfac-48e6-ba3a-fa637de4b23d
      branch:
        type: string
        description:
          Deploy the given branch. The default value is your current branch.
        default: "$testbranch"
      force:
        type: boolean
        description: "Whether or not to force the git push (i.e. `git push -f`). Defaults to false."
        default: false
      only-branch:
        type: stringexecutors:
  default:
    description:
      Uses the basic buildpack-deps image, which has the
      prerequisites for installing heroku's CLI.
    parameters:
      tag:
        type: string
        default: "bionic"
    docker:
      - image: buildpack-deps:<< parameters.tag >>

commands:
  install:
    steps:
      - run:
          name: "Install Heroku CLI, if necessary"
          command: |
            if [[ $(command -v heroku) == "" ]]; then
              curl https://cli-assets.heroku.com/install.sh | sh
            else
              echo "Heroku is already installed. No operation was performed."
            fi

  deploy-via-git:
    parameters:
      app-name:
        description:
          "The name of your Heroku App.
          For backwards compatibility the literal value
          `$HEROKU_APP_NAME` is the default, so you can
          easily use this command by setting an environment
          variable called HEROKU_APP_NAME"
        type: string
        default: $HEROKU_APP_NAME
      maintenance-mode:
        description:
          "Use this to automatically enable mantainance mode before pre-deploy steps
           and have it disabled after post-deploy steps have been run."
        type: boolean
        default: false
      api-key:
        description:
          "The API key to use. defaulting to the literal value $HEROKU_API_KEY, so you can
          populate the environment variable HEROKU_API_KEY and not need to declare a value in code."
        type: string
        default: $HEROKU_API_KEY
      branch:
        type: string
        description:
          Deploy the given branch. The default value is your current branch.
        default: "$CIRCLE_BRANCH"
      force:
        type: boolean
        description: "Whether or not to force the git push (i.e. `git push -f`). Defaults to false."
        default: false
      only-branch: testbranch
        type: string
workflows:
  version: 2
  only_test:
    jobs:
      - test
      - deploy
      


